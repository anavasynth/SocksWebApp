<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оплата замовлення</title>
     <!-- Підключення Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4">Заповніть форму замовлення</h2>

        <!-- Форма замовлення -->
        <form id="orderForm" class="needs-validation" novalidate>
            <div class="mb-3">
                <label for="first_name" class="form-label">Ім'я:</label>
                <input type="text" class="form-control" id="first_name" name="first_name" required>
                <div class="invalid-feedback">Будь ласка, введіть ваше ім'я.</div>
            </div>

            <div class="mb-3">
                <label for="surname" class="form-label">Прізвище:</label>
                <input type="text" class="form-control" id="surname" name="surname" required>
                <div class="invalid-feedback">Будь ласка, введіть ваше прізвище.</div>
            </div>

            <div class="mb-3">
                <label for="phone" class="form-label">Номер телефону:</label>
                <input type="tel" class="form-control" id="phone" name="phone" required>
                <div class="invalid-feedback">Будь ласка, введіть номер телефону.</div>
            </div>

            <div class="mb-3">
                <label for="address" class="form-label">Адреса отримання:</label>
                <input type="text" class="form-control" id="address" name="address" required>
                <div class="invalid-feedback">Будь ласка, введіть адресу.</div>
            </div>

            <button type="submit" class="btn btn-primary w-100">Оформити</button>
        </form>

        <!-- Простір для відображення LiqPay Checkout -->
        <div id="liqpay_checkout" class="mt-4"></div>
    </div>

    <!-- Підключення JS для Bootstrap (для роботи з валідацією форм) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.getElementById("orderForm").addEventListener("submit", function (event) {
    event.preventDefault();

    let orderData = {
        name: document.getElementById("first_name").value,
        surname: document.getElementById("surname").value,
        phone: document.getElementById("phone").value,
        address: document.getElementById("address").value
    };

    // Відправка даних на сервер для ініціалізації платежу
    fetch("/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
    if (data.data && data.signature) {
        alert("Дані збережено! Відображення форми оплати...");

        // Ініціалізація LiqPay Checkout
        LiqPayCheckout.init({
            data: data.data,
            signature: data.signature,
            embedTo: "#liqpay_checkout",
            mode: "popup"
        }).on("liqpay.callback", function (response) {
            console.log("Статус платежу:", response.status);

            // Якщо статус платежу успішний, перевіряємо дані перед відправкою
            if (response.status === "success") {
                if (response.order_id && response.amount && response.description) {
                    fetch("/payment_callback", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            data: data.data,  // Дані платежу, які отримали з сервера
                            signature: data.signature,  // Підпис, який також отримали з сервера
                            status: response.status,
                            //order_id: response.order_id,
                            //amount: response.amount,
                            //description: response.description
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Помилка на сервері при записі платежу.");
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log(data.message); // Повідомлення від сервера
                        alert("Платіж успішний, дані записано в таблицю.");
                    })
                    .catch(error => {
                        console.error("Помилка під час запису в таблицю:", error);
                        alert("Сталася помилка під час обробки платежу.");
                    });
                } else {
                    console.error("Відсутні необхідні дані для запису платежу:", response);
                    alert("Платіж успішний, але не вдалося записати дані.");
                }
            } else {
                console.log("Платіж не успішний.");
                alert("Платіж не був успішним.");
            }
        }).on("liqpay.ready", function () {
            console.log("Готово до оплати");
        }).on("liqpay.close", function () {
            console.log("Вікно платежу закрите");
        });
    } else {
        alert("Помилка при створенні платежу!");
    }
})
    .catch(error => {
        console.error("Помилка при створенні платежу:", error);
        alert("Помилка! Спробуйте ще раз.");
    });
});
</script>
<script src="//static.liqpay.ua/libjs/checkout.js" async></script>
</body>
</html>
